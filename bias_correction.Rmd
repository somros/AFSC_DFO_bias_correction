---
title: "Bias correction for AFSC - DFO data"
author: "Alberto Rovellini"
date: "6/30/2021"
output: html_document
---

# Purpose

This document reads AFSC and DFO bottom trawl data and operates a simple bias correction. COrrection factor is calculated at 10-m depth increments as $\Delta_{j} = \hat{CPUE_{AFSC_{j}}}-\hat{CPUE_{DFO_{j}}}$, where $j$ is a 10-m depth increment, and $\hat{CPUE_{AFSC_{j}}}$ and $\hat{CPUE_{DFO_{j}}}$ are mean CPUE for that species at that depth increment for AFSC and DFO data, respectively. The correction factor is applied to DFO data such that $DFO_{corr} = DFO + \Delta_{j}$ at each depth increment.

The bias correction factors will be applied to the DFO data before running sdmTMB. Note, that this approach does mean that there will not be any zeroes in the DFO data. If delta is small enough, it should not be a big issue in terms of predicted CPUE.

**Delete when operationalized**. We test the workflow on ATF. This will be knitted automatically to produce bias correction factors for each species.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Read data

Read in data as packaged from the knitter. Stitch them into one data set with a column for survey factor.
```{r}
akfin_data <- akfin_data %>% mutate(survey = "AFSC")
dfo_data <- dfo_data %>% mutate(survey = "DFO")

all_data <- rbind(akfin_data, dfo_data) # CAUTION: assuming that the projection is the same - go check
```

## Cut to areas of interest, and view on a map. Turn to sf for this purpose.
```{r}
coast <- map("worldHires", regions = c("Canada", "USA"), plot = FALSE, fill = TRUE)
coast_sf <- coast %>% st_as_sf(crs = 4326) #%>% st_transform(crs = atlantis_bgm$extra$projection)

all_data %>% st_as_sf(coords = c(x = "lon", y = "lat"), crs = 4326) %>%
  ggplot()+
  geom_sf(aes(color = survey))+
  geom_sf(data = coast_sf)+
  coord_sf(xlim = c(-135,-130), ylim=c(53,56))+
  theme_bw()
```
There is no spatial overlap between the two sets. There are hauls at the same latitude at 54.5N for both surveys. Let us use an arbitrary 1 degree in latitude in the two directions: 55N as cutoff for AKFIN data, and 54N for DFO data. 

```{r}
all_data <- all_data %>% filter(lat>=54 & lat <= 55 & lon > -135)
```

Visualise, and split by year, too.
```{r, fig.width = 10, fig.height = 5}
all_data %>% st_as_sf(coords = c(x = "lon", y = "lat"), crs = 4326) %>%
  ggplot()+
  geom_sf(aes(color = survey))+
  geom_sf(data = coast_sf)+
  coord_sf(xlim = c(-135,-130), ylim=c(54,55))+
  theme_bw()+
  facet_wrap(~year)
```
It turns out that there were no hauls in the area of interest in 2003. So let's drop that year from the data.

```{r}
all_data <- all_data %>% filter(year != 2003)
```

# Map depth to depth bins

Keep depth bin calculations in case we change our minds.
```{r}
max_depth <- max(all_data$depth)

all_data <- all_data %>% mutate(depth_bin = cut(all_data$depth, breaks = seq(0,max(all_data$depth),100), labels = seq(100,max(all_data$depth),100)))

all_data <- all_data %>% mutate(depth_bin = ifelse(all_data$depth<max_depth/2,"Shallow","Deep"))
```

# Bias correction

Because of limited overlap between some years and some depths, we need to decide whether we expect a bias to be more consistent over depth in the same year or over time at the same depth. Because, within one area, surveys at different depth in the same year *should* be conducted with the same (or similar) gear and vessels (but we need to double-check this), we may expect a bias between AFSC and DFO data to change over time as sampling gears change, and not so much over different depths. That is we assume that, if in 2005 DFO surveys were biased in the same way at different depths. This may be false, but probably still a safer assumption than bias being depth-specific and constant over time.

This will be done like this for now:

1. Group by survey and year.
2. Take average CPUE.
3. Do AFSC-DFO.
4. Add difference to DFO data points, for each year.
5. Take averages again and see if it is better.

**Note**: we are not grouping by year here. This means that we expect any bias to be the same throughout the sampling period. This is probably not true, but if we keep the year factor we have the issue that not every year there are hauls for each depth bin. Besides, at the ned of this we will stiff average the correction factors over time, because in the end what we need out of sdmTMB is not a temporal output.

```{r}
mean_cpues <- all_data %>% group_by(survey,year,depth_bin) %>%
  summarise(mean_cpue = mean(biom_kgkm2))
```

Have a look at this.
```{r}
ggplot(mean_cpues)+
  geom_bar(aes(x = year, y = mean_cpue, group = survey, fill = survey), position = "dodge", stat = "identity")+
  theme_minimal()+
  labs(title = this_group)+
  facet_wrap(~depth_bin)
```

Save image.
